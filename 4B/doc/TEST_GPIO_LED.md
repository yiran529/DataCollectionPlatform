# GPIO和LED测试脚本使用说明

## 概述

`test_gpio_led.py` 是一个用于测试树莓派4B GPIO按钮和RGB LED的完整测试工具。

## 硬件连接

### GPIO引脚配置 (BCM编号)

| 组件 | GPIO | 物理引脚 | 说明 |
|------|------|----------|------|
| 按钮OUT | GPIO17 | 11 | 三引脚按钮模块的OUT引脚 |
| 按钮VCC | - | 1或17 | 接3.3V电源 |
| 按钮GND | - | 14 | 接GND |
| LED红 | GPIO22 | 15 | 通过330Ω电阻接LED红色引脚 |
| LED绿 | GPIO27 | 13 | 通过330Ω电阻接LED绿色引脚 |
| LED蓝 | GPIO23 | 16 | 通过330Ω电阻接LED蓝色引脚 |
| GND | - | 14 (推荐) | 按钮和LED共阴极，也可使用6/9等 |

### 接线说明

**三引脚按钮模块接线:**
```
按钮模块引脚:
  VCC → 3.3V (物理引脚1或17)
  GND → GND (物理引脚14)
  OUT → GPIO17 (物理引脚11)

工作原理:
  - 松开时: OUT输出HIGH (通过内部上拉)
  - 按下时: OUT输出LOW (接地)
  - GPIO配置: 内部上拉 (PUD_UP)
```

**RGB LED接线 (共阴极):**
```
GPIO22 (物理引脚15) ── 330Ω ── LED红色引脚
GPIO27 (物理引脚13) ── 330Ω ── LED绿色引脚  
GPIO23 (物理引脚16) ── 330Ω ── LED蓝色引脚
                        LED共阴极 ── GND (物理引脚14)
```

**物理引脚布局 (从上往下看，USB口朝下):**
```
    3V3 (1) ← 按钮VCC  (2)  5V
  GPIO2  (3)  (4)  5V
  GPIO3  (5)  (6)  GND
  GPIO4  (7)  (8)  GPIO14
    GND  (9)  (10) GPIO15
按钮OUT GPIO17 (11) (12) GPIO18
LED绿 GPIO27 (13) (14) GND   ← GND (按钮和LED共用)
LED红 GPIO22 (15) (16) GPIO23 ← LED蓝
  GPIO10 (17) (18) GPIO24
       ...
```

**三引脚按钮模块连接示意图:**
```
树莓派4B                    按钮模块
─────────────────          ──────────
3.3V (引脚1) ─────────────→ VCC
GND  (引脚14) ────────────→ GND
GPIO17 (引脚11) ──────────→ OUT
```

## 使用方法

### 基本使用

```bash
cd /home/cjq/Documents/DataCollectionPlatform/4B
sudo python3 test_gpio_led.py
```

### 运行所有测试

```bash
sudo python3 test_gpio_led.py --all
```

### 自定义GPIO引脚

```bash
# 自定义按钮引脚
sudo python3 test_gpio_led.py --button 17

# 自定义所有引脚
sudo python3 test_gpio_led.py --button 17 --led-red 22 --led-green 27 --led-blue 23
```

## 测试项目

### 1. LED单色测试
- 依次点亮红色、绿色、蓝色LED
- 每个颜色持续2秒
- 用于验证每个LED通道是否正常工作

### 2. LED组合颜色测试
- 依次显示黄色、青色、紫色、白色
- 每个颜色持续2秒
- 用于验证LED组合颜色是否正常

### 3. LED闪烁测试
- LED按红→绿→蓝的顺序循环闪烁
- 共3轮，每轮每个颜色闪烁0.5秒
- 用于验证LED快速切换是否正常

### 4. 按钮按下测试
- 要求按下按钮5次
- 每次按下LED会改变颜色（红→绿→蓝→黄→白）
- 用于验证按钮是否正常工作

### 5. 按钮状态监测
- 持续监测按钮状态
- 按下时LED变红，松开时LED变绿
- 实时显示按钮状态变化

## 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--button` | 按钮GPIO引脚 (BCM编号) | 18 |
| `--led-red` | 红色LED GPIO引脚 | 22 |
| `--led-green` | 绿色LED GPIO引脚 | 27 |
| `--led-blue` | 蓝色LED GPIO引脚 | 23 |
| `--all` | 运行所有测试 | - |

## 常见问题

### 1. 权限错误

**错误信息:**
```
GPIO初始化失败: ...
```

**解决方法:**
```bash
# 方法1: 使用sudo运行
sudo python3 test_gpio_led.py

# 方法2: 将用户添加到gpio组
sudo usermod -aG gpio $USER
# 然后重新登录或执行:
newgrp gpio
```

### 2. LED不亮

**可能原因:**
- 接线错误（检查物理引脚编号）
- 电阻值过大或过小
- LED极性接反（共阴极/共阳极）

**检查步骤:**
1. 确认使用的是BCM编号，不是物理引脚编号
2. 检查LED是否共阴极（共阴极需要接GND）
3. 检查电阻值（建议330Ω-1kΩ）

### 3. 按钮无响应

**可能原因:**
- 按钮未接GND
- 按钮引脚错误
- 按钮损坏

**检查步骤:**
1. 确认按钮一端接GPIO18，另一端接GND
2. 使用万用表测试按钮是否导通
3. 检查GPIO引脚是否正确

### 4. 颜色显示错误

**可能原因:**
- R/G/B引脚接反
- LED内部接线错误

**解决方法:**
对照引脚定义重新检查接线：
- 红色应该接GPIO22
- 绿色应该接GPIO27
- 蓝色应该接GPIO23

## 模拟模式

如果未安装 `RPi.GPIO` 库，脚本会自动进入模拟模式：
- LED操作会打印到控制台
- 按钮操作会被模拟
- 可以用于测试脚本逻辑，但无法测试实际硬件

## 退出程序

- 在任何测试中按 `Ctrl+C` 可退出
- 程序会自动清理GPIO资源
- LED会在退出时关闭

## 注意事项

1. **必须使用sudo运行**（除非用户已在gpio组中）
2. **确保接线正确**，错误的接线可能损坏GPIO
3. **使用限流电阻**，直接连接LED可能损坏GPIO或LED
4. **共阴极LED**，本脚本假设使用共阴极RGB LED
5. **按钮防抖**，脚本内置了防抖处理，避免误触发

## 测试流程建议

1. **首先运行LED单色测试** - 确认每个LED通道正常
2. **然后运行组合颜色测试** - 确认LED组合正常
3. **运行按钮测试** - 确认按钮和LED联动正常
4. **最后运行状态监测** - 持续观察按钮和LED状态

## 相关文件

- `gpio_data_collector.py` - 主数据收集程序
- `README.md` - 项目主文档
- `FIX_GPIO_PERMISSIONS.md` - GPIO权限修复指南

