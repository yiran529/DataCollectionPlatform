# 实时写入性能问题分析与解决方案

## 问题根源

当前架构的致命缺陷：
```
录制线程 → [原始数据] → 队列 → 写入线程 → [对齐+校正+编码+写入]
                                        ↑
                                   严重瓶颈！
```

写入线程需要做：
1. **对齐算法**（二分查找）- CPU密集
2. **立体校正**（remap）- CPU密集，每帧2次
3. **JPEG编码**（imencode）- CPU密集，每帧2次
4. **HDF5写入**（resize+write）- IO密集

**结果**：写入线程处理1批数据可能需要0.5-1秒，而录制线程每0.1秒产生1批！

## 解决方案对比

### 方案1：预处理架构（推荐）⭐
```
录制线程 → [对齐+校正+编码] → 队列 → 写入线程 → [仅写入]
```

**优点**：
- 写入线程只做IO，速度快10倍+
- 录制线程有0.1秒周期处理时间充足
- 队列存的是压缩数据，内存占用小

**缺点**：
- 录制线程负担增加（但周期内足够）

### 方案2：降低质量（临时方案）
```yaml
save:
  jpeg_quality: 50  # 从85降到50
```

**优点**：立即见效，编码速度提升3-4倍

**缺点**：图像质量显著下降

### 方案3：禁用立体校正（临时方案）
在config.yaml中注释掉calibration配置

**优点**：省去最耗时的remap操作

**缺点**：失去校正功能

## 推荐实施步骤

### 立即可用的临时方案（无需修改代码）

**步骤1**：降低JPEG质量
```yaml
# config.yaml
save:
  jpeg_quality: 60  # 降低到60
```

**步骤2**：如果不需要校正，暂时禁用
```yaml
# config.yaml - 注释掉或删除calibration部分
right_hand:
  stereo:
    # calibration: ...  # 注释掉整个calibration块
```

**预期效果**：
- 编码速度提升 2-3x
- 校正省去 ~50% CPU时间
- 队列堆积应降低到可接受范围

### 长期方案（需要修改代码）

修改架构，让录制线程完成预处理：

**核心改动**：
1. 录制线程每0.1秒：获取数据 → 对齐 → 校正 → 编码 → 入队
2. 写入线程：出队 → 写HDF5（仅IO）

**好处**：
- 写入速度提升10倍+
- 可以保持高质量（jpeg_quality=85）
- 可以保持立体校正功能

## 性能对比（预估）

| 方案 | 写入速度 | 队列堆积 | 图像质量 | 校正功能 |
|------|---------|---------|---------|---------|
| 当前 | ~0.7fps | 严重 | 高 | ✅ |
| 降质量(60) | ~2fps | 中等 | 中 | ✅ |
| 禁用校正 | ~1.5fps | 中等 | 高 | ❌ |
| 降质量+禁用校正 | ~4fps | 轻微 | 中 | ❌ |
| 预处理架构 | ~30fps | 无 | 高 | ✅ |

## 快速测试命令

```bash
# 测试1：降低质量到60
# 修改config.yaml中的jpeg_quality为60
python single_hand_collector.py -r

# 测试2：禁用校正
# 在config.yaml中注释掉calibration块
python single_hand_collector.py -r

# 观察：队列大小应该明显减少
```

## 推荐行动

**现在就做**：
1. 将`jpeg_quality`改为`60`
2. 如果不需要校正，暂时注释掉`calibration`配置
3. 重新测试

**长期计划**：
如果需要保持高质量和校正功能，需要重构代码实现预处理架构。

---

**关键点**：问题不在批次大小、队列大小或flush频率，而是**谁来做CPU密集型工作**。写入线程应该只做IO！
