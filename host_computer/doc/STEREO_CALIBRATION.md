# 双目相机标定指南

## 问题说明

如果双目相机的左右图像高度不一致（一个高一个低），会严重影响双目SLAM的精度，因为：

1. **视差计算错误**: 高度不一致会导致同一物体在左右图像中的行号不匹配
2. **深度估计偏差**: 错误的视差会导致深度计算错误
3. **特征匹配困难**: 立体匹配算法假设左右图像水平对齐

## 解决方案

通过**立体标定和校正**可以解决这个问题：

1. **立体标定**: 计算左右相机的内参、外参和相对位置
2. **立体校正**: 将左右图像重投影到同一平面上，使它们水平对齐

## 使用流程

### 步骤1: 准备棋盘格

- 打印一个棋盘格（建议A4纸大小）
- 棋盘格内角点数：11x8（列x行）或其他尺寸
- 方格边长：25mm（或其他已知尺寸）

### 步骤2: 采集标定图像

```bash
cd /home/cjq/Documents/DataCollectionPlatform/host_computer
python3 stereo_calibration.py --capture --checkerboard 11x8 --square_size 25
```

**操作说明**:
- 按 `c` 或空格键: 捕获当前帧
- 按 `q`: 退出采集
- 绿色角点: 检测成功
- 红色文字: 检测失败

**采集建议**:
- 采集至少15-20对图像
- 将棋盘格放在不同位置、角度、距离
- 确保棋盘格在左右图像中都清晰可见
- 覆盖整个视野范围
- 包括近距离、远距离、不同角度

### 步骤3: 执行标定

```bash
python3 stereo_calibration.py --calibrate --checkerboard 11x8
```

标定会：
1. 检测所有图像中的角点
2. 分别标定左右相机内参
3. 进行双目标定，计算相对位置
4. 计算立体校正参数
5. 保存标定结果到 `stereo_calibration/stereo_calibration.json`

### 步骤4: 验证校正效果

```bash
python3 stereo_calibration.py --verify
```

验证窗口会显示：
- **上半部分**: 原始图像（未校正）
- **下半部分**: 校正后的图像
- **绿色水平线**: 用于检查对齐效果

**检查要点**:
- 校正后的左右图像应该水平对齐
- 同一水平线上的物体应该在左右图像中的同一行
- 畸变应该被校正

## 标定结果

标定完成后，会生成 `stereo_calibration/stereo_calibration.json` 文件，包含：

- **内参**: 左右相机的内参矩阵和畸变系数
- **外参**: 左右相机的相对旋转和平移
- **校正参数**: 用于实时校正的映射矩阵
- **基线距离**: 左右相机之间的距离（mm）

## 在数据收集中使用校正

标定完成后，可以在数据收集程序中使用校正参数来实时校正图像。

## 常见问题

### 1. 角点检测失败

**原因**:
- 棋盘格不够清晰
- 光照不足
- 棋盘格被遮挡

**解决**:
- 确保棋盘格清晰可见
- 改善光照条件
- 调整相机焦距

### 2. 标定误差大

**原因**:
- 标定图像数量不足
- 标定图像质量差
- 棋盘格尺寸设置错误

**解决**:
- 采集更多标定图像（至少15对）
- 确保棋盘格平整
- 检查方格尺寸是否正确

### 3. 校正后仍有高度差

**原因**:
- 标定图像质量差
- 相机物理位置变化

**解决**:
- 重新采集标定图像
- 确保相机固定牢固
- 检查相机是否松动

## 标定参数说明

### 棋盘格尺寸

- **内角点数**: 棋盘格内部角点的数量（列x行）
- **方格边长**: 每个方格的实际边长（mm）

**常见配置**:
- 11x8 内角点，25mm 方格（适合A4纸）
- 9x6 内角点，30mm 方格
- 7x5 内角点，40mm 方格

### 相机配置

标定工具会自动从 `config.yaml` 读取相机配置，或可以通过 `--device` 参数指定。

## 技术细节

### 立体校正原理

1. **立体标定**: 计算左右相机的相对位置（旋转R和平移T）
2. **立体校正**: 将左右图像重投影到同一平面上
3. **结果**: 左右图像水平对齐，同一行对应同一水平线

### 校正映射

校正使用查找表（LUT）实现，包括：
- `map1`: x坐标映射
- `map2`: y坐标映射

这些映射可以预先计算并保存，用于实时校正。

