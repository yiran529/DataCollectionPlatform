## 所有改动说明

### **1. 诊断脚本（用于问题排查）**

#### 📄 diagnose_crash.py
- **目的**：逐步测试各个模块，找出导致 "Illegal instruction" 崩溃的原因
- **测试内容**：Python基础 → NumPy → OpenCV → YAML → h5py → sync_data_collector → 摄像头初始化
- **用途**：当程序崩溃时，逐步运行诊断找出问题所在

#### 📄 diagnose_jetson.py
- **目的**：Jetson Xavier 专用诊断工具
- **功能**：使用 subprocess 测试 NumPy/OpenCV 导入（避免直接导入导致进程崩溃）
- **输出**：判断是否能使用系统包，还是需要环境变量修复

#### 📄 detect_cameras.py
- **目的**：自动检测 Jetson 上的摄像头设备
- **检测方法**：
  - 扫描 `/dev/video*` 设备文件
  - 逐个尝试用 OpenCV 打开
  - 显示每个摄像头的分辨率和 FPS
- **输出**：自动建议需要修改的 config.yaml 配置

---

### **2. 配置文件修改**

#### 📝 config.yaml

**改动前：**
```yaml
left_hand:
  mono:
    device: 10        # ❌ 不存在的设备
    fps: 30
  stereo:
    device: 8         # ❌ 不存在的设备
    fps: 30

right_hand:
  mono:
    device: 6         # ❌ 不存在的设备
    fps: 30
  stereo:
    device: 4         # ❌ 不存在的设备
    fps: 30
```

**改动后：**
```yaml
left_hand:
  mono:
    device: 1         # ✅ 真实设备：1600x1300 @ 5fps
    width: 1600
    height: 1300
    fps: 5
  stereo:
    device: 0         # ✅ 真实设备：3840x1080 @ 1fps
    width: 3840
    height: 1080
    fps: 1

right_hand:
  mono:
    device: 1         # ✅ 真实设备
    width: 1600
    height: 1300
    fps: 5
  stereo:
    device: 0         # ✅ 真实设备
    width: 3840
    height: 1080
    fps: 1
```

**原因**：
- 原始配置中的设备号（4,6,8,10）在你的 Jetson Xavier 上不存在
- 诊断脚本找到了真实的摄像头：`/dev/video0` 和 `/dev/video1`
- 更新了分辨率和 FPS 以匹配实际硬件

---

### **3. 摄像头驱动代码修改**

#### 📝 sync_data_collector.py - `open()` 方法

**改动前：**
```python
def open(self) -> bool:
    # 检测是否为 Jetson 平台，优先使用 GStreamer 以获得更好的性能
    use_gstreamer = self._is_jetson_platform()  # ❌ 自动启用硬件加速
    
    if use_gstreamer:
        # GStreamer 管道
        gst_pipeline = (
            f"v4l2src device=/dev/video{self.device_id} ! "
            f"image/jpeg,width={self.width},height={self.height},framerate={self.fps}/1 ! "
            f"jpegdec ! videoconvert ! appsink"
        )
        self.cap = cv2.VideoCapture(gst_pipeline, cv2.CAP_GSTREAMER)
```

**改动后：**
```python
def open(self) -> bool:
    # 注意：GStreamer 在某些 Jetson 配置下可能不稳定，默认禁用
    # 如需启用 GStreamer，设置环境变量: export USE_GSTREAMER=1
    use_gstreamer = os.environ.get('USE_GSTREAMER', '0') == '1' and self._is_jetson_platform()
    
    if use_gstreamer:
        # GStreamer 管道
        ...
    else:
        # 树莓派或其他平台：使用标准 V4L2
        self.cap = cv2.VideoCapture(self.device_id)
        print(f"[{self.name}] 使用标准 V4L2 模式")  # ✅ 新增
```

**改动原因**：

你遇到的错误：
```
GStreamer warning: Embedded video playback halted; module v4l2src1 reported: Internal data stream error.
```

这是因为：
1. **GStreamer 硬件加速需要特定的摄像头支持** → 你的摄像头不支持 JPEG 硬件编码
2. **V4L2 格式不匹配** → 自动使用 JPEG，但摄像头可能输出其他格式（如 YUV）
3. **同时访问冲突** → Stereo 和 Mono 摄像头可能在同一物理设备上

**解决方案**：
- ✅ **默认禁用 GStreamer**（改用标准 V4L2 更稳定）
- ✅ **通过环境变量 `USE_GSTREAMER=1` 可选启用**（需要时可恢复）
- ✅ **自动格式协商**（V4L2 会自动选择兼容的格式）

---

### **4. 新增测试脚本**

#### 📄 test_cameras.py
- **目的**：测试摄像头能否正常采集数据
- **步骤**：
  1. 禁用 GStreamer（`export USE_GSTREAMER=0`）
  2. 分别打开 Mono 和 Stereo 摄像头
  3. 各采集 0.5 秒数据
  4. 验证帧数和数据完整性

---

## 改动效果对比

| 问题 | 改动前 | 改动后 |
|------|--------|--------|
| **设备号错误** | ❌ 程序无法找到摄像头 | ✅ 自动检测正确的设备号 |
| **GStreamer 失败** | ❌ "Internal data stream error" | ✅ 改用标准 V4L2 模式 |
| **故障诊断** | ❌ 不知道问题在哪 | ✅ 有多个诊断脚本逐步定位 |
| **灵活性** | ❌ 硬编码 GStreamer | ✅ 可通过环境变量控制 |

---

## 使用改动后的程序

```bash
cd ~/DataCollectionPlatform

# 禁用 GStreamer（推荐）
export USE_GSTREAMER=0

# 运行数据采集
python3 ./host_computer/single_hand_collector.py --config ./host_computer/config.yaml --hand right --visualize
```

**如果将来要启用 GStreamer**：
```bash
export USE_GSTREAMER=1
python3 ./host_computer/single_hand_collector.py ...
```

---

## 总体改动策略

```
问题排查流程：
  1. diagnose_crash.py      → 找出导致崩溃的库
  2. diagnose_jetson.py     → Jetson 专用诊断
  3. detect_cameras.py      → 自动检测摄像头
  4. config.yaml 自动更新   → 使用正确的设备号
  5. sync_data_collector.py → 禁用有问题的 GStreamer
  
结果：✅ 程序成功启动，可以采集数据
```